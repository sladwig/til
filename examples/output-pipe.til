print "START"

proc generator (q n) {
    print "generator started"

    range $n | foreach i {
        push $q "i=$i"
    }

    push $q "quit"
    print "generator ended"
}

set counter 0
queue | as queue
spawn {generator $queue 4}
receive $queue | foreach i {
    print "i:$i"
    if ($i == "quit") {
        break
    }
    incr $counter
}
assert ($counter == 5)

print "END"
