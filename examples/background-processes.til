print "START"

queue | as q

proc p (q) {
    push $q "x"
}

range 1 3 | foreach x {
    push $q $x
    spawn {p $q}
    sleep 50
}

sleep 50
set result ""
receive.no_wait $q | foreach x {
    set result "$result $x"
}
assert ($result == " 1 x 2 x 3 x")

print "END"
