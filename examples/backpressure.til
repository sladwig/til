print "START"

queue | as q

proc p (q) {
    print "new call to p"
    read | foreach msg {
        push $q $msg
        break
    }
    read.no_wait | foreach msg {
        push $q $msg
    }
}

spawn {p $q} | as p1

print "sending data to p1"
range 3 | foreach x {
    send $p1 $x
}

sleep 50
print "receiving (nowait) from q"
set result ""
receive.no_wait $q | foreach x {
    set result "$result $x"
}

print "result: $result"
assert ($result == " 0 1 2 3")

print "END"
