print "START"

set q [queue]

proc p (q) {
    read | foreach msg {
        push $q $msg
        break
    }
    read.no_wait | foreach msg {
        push $q $msg
    }
}

set p1 [spawn p $q]

range 3 | foreach x {
    send $p1 $x
}

sleep 50
set result ""
receive.no_wait $q | foreach x {
    set result "$result $x"
}

print "result: $result"
assert ($result == " 0 1 2 3")

print "END"
