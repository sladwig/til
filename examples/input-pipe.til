print "START"

set counter 0

proc printer (q) {
    print "printer started"
    sleep 500
    receive.no_wait $q | foreach line {
        print "> $line"
    }
    print "printer ended"
    incr $counter
}

queue | as queue
set p [spawn {printer $queue}]
range 4 | foreach x {
    push $queue $x
}

assert ($counter == 0)

# After some time:
# assert ($counter == 5)

print "END"
